<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-S3 Binary Uploader</title>
</head>
<body>
    <h1>ESP32-S3 Binary Uploader</h1>
    <input type="file" id="fileInput" accept=".bin" />
    <button id="connectBtn">Connect to ESP32</button>
    <button id="uploadBtn" disabled>Upload Binary</button>
    <progress id="progressBar" value="0" max="100" style="display: none;"></progress>
    <p id="status"></p>

    <script type="module">
        import { ESPLoader } from './path/to/bundle.js'; // Update this path as needed

        let port, espTool;
        let connected = false;

        const fileInput = document.getElementById("fileInput");
        const connectBtn = document.getElementById("connectBtn");
        const uploadBtn = document.getElementById("uploadBtn");
        const progressBar = document.getElementById("progressBar");
        const status = document.getElementById("status");

        // Function to connect to ESP32
        connectBtn.addEventListener("click", async () => {
            if (!connected) {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });
                    espTool = new ESPLoader(port);
                    await espTool.initialize();
                    connected = true;
                    status.textContent = "Connected to ESP32";
                    connectBtn.textContent = "Disconnect";
                    uploadBtn.disabled = false;
                } catch (err) {
                    status.textContent = `Connection failed: ${err.message}`;
                }
            } else {
                await port.close();
                connected = false;
                status.textContent = "Disconnected";
                connectBtn.textContent = "Connect to ESP32";
                uploadBtn.disabled = true;
            }
        });

        // Function to upload binary file
        uploadBtn.addEventListener("click", async () => {
            if (!fileInput.files.length) {
                alert("Please select a binary file to upload.");
                return;
            }

            const file = fileInput.files[0];
            const fileBuffer = await file.arrayBuffer();
            const fileArray = new Uint8Array(fileBuffer);

            progressBar.style.display = "block";
            progressBar.value = 0;
            status.textContent = "Starting upload...";

            try {
                await espTool.flashData(
                    fileArray,
                    0x000, // Starting address
                    (bytesWritten, totalBytes) => {
                        const progress = (bytesWritten / totalBytes) * 100;
                        progressBar.value = progress;
                        status.textContent = `Uploading... ${Math.floor(progress)}%`;
                    }
                );
                status.textContent = "Upload complete!";
            } catch (err) {
                status.textContent = `Upload failed: ${err.message}`;
            } finally {
                progressBar.style.display = "none";
            }
        });
    </script>
</body>
</html>
