<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ESP32 Flasher 1</title>
</head>
<body>
    <button id="connect">Connect</button>
    <button id="load">Load Binary</button>
    <button id="flash" disabled>Flash</button>
    <p id="status"></p>
    <progress id="progress" max="100" value="0"></progress>

    <script type="module">

        import { ESPLoader } from 'https://unpkg.com/esptool-js/lib/index.js';


        let espTool, port, fileArray;

        async function connect() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                espTool = new ESPLoader(port);
                await espTool.initialize();
                document.getElementById("status").textContent = "Connected";
                document.getElementById("flash").disabled = false;
            } catch (error) {
                console.error(error);
                document.getElementById("status").textContent = "Failed to connect";
            }
        }

        async function loadFile() {
            const [fileHandle] = await window.showOpenFilePicker();
            const file = await fileHandle.getFile();
            fileArray = new Uint8Array(await file.arrayBuffer());
            document.getElementById("status").textContent = "Binary loaded";
        }

        async function flashFile() {
            try {
                await espTool.flashData(fileArray, 0x000, (written, total) => {
                    const progress = (written / total) * 100;
                    document.getElementById("progress").value = progress;
                    document.getElementById("status").textContent = `Flashing: ${Math.floor(progress)}%`;
                });
                document.getElementById("status").textContent = "Flash complete!";
            } catch (error) {
                console.error(error);
                document.getElementById("status").textContent = "Flash failed";
            }
        }

        document.getElementById("connect").addEventListener("click", connect);
        document.getElementById("load").addEventListener("click", loadFile);
        document.getElementById("flash").addEventListener("click", flashFile);
    </script>
</body>
</html>
